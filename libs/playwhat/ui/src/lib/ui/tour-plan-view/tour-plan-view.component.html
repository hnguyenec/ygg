<div class="tour-plan-view" *ngIf="theThing" [formGroup]="formGroup">
  <div
    *ngIf="!readonly"
    fxLayout="row"
    fxLayoutAlign="end center"
    fxLayoutGap="10px"
  >
    <button
      type="button"
      mat-fab
      class="save edit"
      matTooltip="儲存遊程規劃"
      [disabled]="formGroup.invalid"
      (click)="save()"
    >
      <mat-icon>save</mat-icon>
    </button>
  </div>
  <ygg-omni-type-view-control
    class="tour-plan-name"
    formControlName="name"
    type="text"
    [editable]="!readonly"
    [viewStyle]="nameStyle"
  >
    <div errors>
      <div *ngIf="formControlName.errors?.required">
        請填入遊程名稱
      </div>
    </div>
  </ygg-omni-type-view-control>

  <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">
    <div>
      <h4 class="state">{{ stateLabel }}</h4>
    </div>
    <div *ngIf="canSubmitApplication && !readonly">
      <button
        type="button"
        mat-mini-fab
        class="submit-application edit"
        (click)="submitApplication()"
      >
        <mat-icon>send</mat-icon>
      </button>
    </div>
    <div *ngIf="canCancelApplied && !readonly">
      <button
        type="button"
        mat-mini-fab
        class="cancel-applied edit"
        (click)="cancelApplied()"
        matTooltip="取消此遊程申請"
      >
        <mat-icon>backspace</mat-icon>
      </button>
    </div>
    <div *ngIf="isAdmin && !readonly" [ngSwitch]="state">
      <div *ngSwitchCase="states.applied">
        <button
          type="button"
          mat-mini-fab
          class="admin-paid edit"
          (click)="adminPaid()"
          matTooltip="標記此遊程已付款完成"
        >
          <mat-icon>payment</mat-icon>
        </button>
      </div>
      <div *ngSwitchCase="states.paid">
        <button
          type="button"
          mat-mini-fab
          class="admin-complete edit"
          (click)="adminComplete()"
          matTooltip="標記此遊程已全部完成"
        >
          <mat-icon>done_all</mat-icon>
        </button>
      </div>
      <div *ngSwitchDefault></div>
    </div>
  </div>
  <div *ngFor="let cell of requiredCells; let idx = index">
    <div
      [attr.cell-name]="cell.name"
      [hidden]="isPreviousCellInvalid(idx)"
      *ngIf="formGroup.get(cell.name) as formControl"
    >
      <h4>{{ cell.name }}</h4>
      <ygg-omni-type-view-control
        [formControlName]="cell.name"
        [type]="cell.type"
        [editable]="!readonly"
      >
        <div errors>
          <div *ngIf="formControl.errors?.required">請填入{{ cell.name }}</div>
        </div>
      </ygg-omni-type-view-control>

      <!-- <the-thing-cell-view
        [cell]="cell"
        [editable]="!readonly"
      ></the-thing-cell-view> -->
    </div>
  </div>
  <div class="optionals" [hidden]="!isRequiredCellsFilled()">
    <br /><br />
    <div class="purchases">
      <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">
        <div>
          <h2>預訂品項</h2>
        </div>
        <div *ngIf="!readonly">
          <button
            type="button"
            mat-mini-fab
            class="goto-edit-purchases edit"
            (click)="gotoEditPurchases()"
          >
            <mat-icon>edit</mat-icon>
          </button>
        </div>
      </div>
      <ygg-purchase-list [purchases]="purchases"></ygg-purchase-list>
    </div>
    <br /><br />
    <div class="optional-cells">
      <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">
        <h2>
          其他需求事項
        </h2>
        <div *ngIf="!readonly">
          <button
            type="button"
            mat-mini-fab
            class="add-cell edit"
            (click)="addCell()"
          >
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>
      <div *ngFor="let cell of getOptionalCells()">
        <div [attr.cell-name]="cell.name" *ngIf="cell.value">
          <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">
            <h4>{{ cell.name }}</h4>
            <div>
              <button
                type="button"
                class="delete"
                mat-mini-fab
                matTooltip="移除這個欄位"
                (click)="deleteCell(cell)"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          <the-thing-cell-view
            [cell]="cell"
            [editable]="!readonly"
          ></the-thing-cell-view>
        </div>
      </div>
    </div>
  </div>
</div>
