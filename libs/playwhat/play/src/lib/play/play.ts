import { extend, sample } from 'lodash';
import { v4 as uuid } from 'uuid';
import { DataItem, toJSONDeep } from '@ygg/shared/infra/data-access';
import {
  FormGroupModel,
  FormControlModel,
  FormControlType
} from '@ygg/shared/types';
import { Album } from '@ygg/shared/types';

export class Play implements DataItem {
  id: string;
  name: string;
  introduction: string;
  album: Album;

  static forge(): Play {
    const newOne = new Play();
    newOne.name = sample([
      '總統府遛鳥',
      '馬里雅納海溝深潛',
      '佔領釣魚台',
      '掛川花鳥園',
      '南極企鵝摔角',
      '大成王功淨灘',
      '野外踏青捉蟬',
      '獨角仙夏令營'
    ]);
    newOne.introduction = `
    孔雀東南飛，五里一徘徊。
    “十三能織素，十四學裁衣。十五彈箜篌，十六誦詩書。十七爲君婦，心中常苦悲。君既爲府吏，守節情不移。賤妾留空房，相見常日稀。雞鳴入機織，夜夜不得息。三日斷五匹，大人故嫌遲。非爲織作遲，君家婦難爲！妾不堪驅使，徒留無所施。便可白公姥，及時相遣歸。”
    府吏得聞之，堂上啓阿母：“兒已薄祿相，幸復得此婦。結髮同枕蓆，黃泉共爲友。共事二三年，始爾未爲久。女行無偏斜，何意致不厚。”
    阿母謂府吏：“何乃太區區！此婦無禮節，舉動自專由。吾意久懷忿，汝豈得自由！東家有賢女，自名秦羅敷。可憐體無比，阿母爲汝求。便可速遣之，遣去慎莫留！”
    府吏長跪告：“伏惟啓阿母。今若遣此婦，終老不復取！”
    阿母得聞之，槌牀便大怒：“小子無所畏，何敢助婦語！吾已失恩義，會不相從許！”
    府吏默無聲，再拜還入戶。舉言謂新婦，哽咽不能語：“我自不驅卿，逼迫有阿母。卿但暫還家，吾今且報府。不久當歸還，還必相迎取。以此下心意，慎勿違吾語。”
    新婦謂府吏：“勿復重紛紜。往昔初陽歲，謝家來貴門。奉事循公姥，進止敢自專？晝夜勤作息，伶俜縈苦辛。謂言無罪過，供養卒大恩；仍更被驅遣，何言復來還！妾有繡腰襦，葳蕤自生光；紅羅復斗帳，四角垂香囊；箱簾六七十，綠碧青絲繩，物物各自異，種種在其中。人賤物亦鄙，不足迎後人，留待作遺施，於今無會因。時時爲安慰，久久莫相忘！”
    雞鳴外慾曙，新婦起嚴妝。著我繡夾裙，事事四五通。足下躡絲履，頭上玳瑁光。腰若流紈素，耳著明月璫。指如削蔥根，口如含朱丹。纖纖作細步，精妙世無雙。
    上堂拜阿母，阿母怒不止。“昔作女兒時，生小出野裏。本自無教訓，兼愧貴家子。受母錢帛多，不堪母驅使。今日還家去，念母勞家裏。”卻與小姑別，淚落連珠子。“新婦初來時，小姑始扶牀；今日被驅遣，小姑如我長。勤心養公姥，好自相扶將。初七及下九，嬉戲莫相忘。”出門登車去，涕落百餘行。
    府吏馬在前，新婦車在後。隱隱何甸甸，俱會大道口。下馬入車中，低頭共耳語：“誓不相隔卿，且暫還家去。吾今且赴府，不久當還歸。誓天不相負！”
    新婦謂府吏：“感君區區懷！君既若見錄，不久望君來。君當作磐石，妾當作蒲葦。蒲葦紉如絲，磐石無轉移。我有親父兄，性行暴如雷，恐不任我意，逆以煎我懷。”舉手長勞勞，二情同依依 。
    入門上家堂，進退無顏儀。阿母大拊掌，不圖子自歸：“十三教汝織，十四能裁衣，十五彈箜篌，十六知禮儀，十七遣汝嫁，謂言無誓違。汝今何罪過，不迎而自歸？”蘭芝慚阿母：“兒實無罪過。”阿母大悲摧。
    還家十餘日，縣令遣媒來。雲有第三郎，窈窕世無雙。年始十八九，便言多令才。
    阿母謂阿女：“汝可去應之。”
    阿女含淚答：“蘭芝初還時，府吏見丁寧，結誓不別離。今日違情義，恐此事非奇。自可斷來信，徐徐更謂之。”
    阿母白媒人：“貧賤有此女，始適還家門。不堪吏人婦，豈合令郎君？幸可廣問訊，不得便相許。”
    媒人去數日，尋遣丞請還，說有蘭家女，承籍有宦官。雲有第五郎，嬌逸未有婚。遣丞爲媒人，主簿通語言。直說太守家，有此令郎君，既欲結大義，故遣來貴門。
    阿母謝媒人：“女子先有誓，老姥豈敢言！”
    阿兄得聞之，悵然心中煩。舉言謂阿妹：“作計何不量！先嫁得府吏，後嫁得郎君。否泰如天地，足以榮汝身。不嫁義郎體，其往欲何雲？”
    蘭芝仰頭答：“理實如兄言。謝家事夫婿，中道還兄門。處分適兄意，那得自任專！雖與府吏要，渠會永無緣。登即相許和，便可作婚姻。”
    媒人下牀去。諾諾復爾爾。還部白府君：“下官奉使命，言談大有緣。”府君得聞之，心中大歡喜。視歷復開書，便利此月內，六合正相應。良吉三十日，今已二十七，卿可去成婚。交語速裝束，絡繹如浮雲。青雀白鵠舫，四角龍子幡。婀娜隨風轉，金車玉作輪。躑躅青驄馬，流蘇金鏤鞍。齎錢三百萬，皆用青絲穿。雜彩三百匹，交廣市鮭珍。從人四五百，鬱郁登郡門。
    阿母謂阿女：“適得府君書，明日來迎汝。何不作衣裳？莫令事不舉！”
    阿女默無聲，手巾掩口啼，淚落便如瀉。移我琉璃榻，出置前窗下。左手持刀尺，右手執綾羅。朝成繡夾裙，晚成單羅衫。晻晻日欲暝，愁思出門啼。
    府吏聞此變，因求假暫歸。未至二三裏，摧藏馬悲哀。新婦識馬聲，躡履相逢迎。悵然遙相望，知是故人來。舉手拍馬鞍，嗟嘆使心傷：“自君別我後，人事不可量。果不如先願，又非君所詳。我有親父母，逼迫兼弟兄。以我應他人，君還何所望！”
    府吏謂新婦：“賀卿得高遷！磐石方且厚，可以卒千年；蒲葦一時紉，便作旦夕間。卿當日勝貴，吾獨向黃泉！”
    新婦謂府吏：“何意出此言！同是被逼迫，君爾妾亦然。黃泉下相見，勿違今日言！”執手分道去，各各還家門。生人作死別，恨恨那可論？念與世間辭，千萬不復全！
    府吏還家去，上堂拜阿母：“今日大風寒，寒風摧樹木，嚴霜結庭蘭。兒今日冥冥，令母在後單。故作不良計，勿復怨鬼神！命如南山石，四體康且直！”
    阿母得聞之，零淚應聲落：“汝是大家子，仕宦於臺閣。慎勿爲婦死，貴賤情何薄！東家有賢女，窈窕豔城郭，阿母爲汝求，便覆在旦夕。”
    府吏再拜還，長嘆空房中，作計乃爾立。轉頭向戶裏，漸見愁煎迫。
    其日牛馬嘶，新婦入青廬。奄奄黃昏後，寂寂人定初。我命絕今日，魂去屍長留！攬裙脫絲履，舉身赴清池。
    府吏聞此事，心知長別離。徘徊庭樹下，自掛東南枝。
    兩家求合葬，合葬華山傍。東西植松柏，左右種梧桐。枝枝相覆蓋，葉葉相交通。中有雙飛鳥，自名爲鴛鴦。仰頭相向鳴，夜夜達五更。行人駐足聽，寡婦起彷徨。多謝後世人，戒之慎勿忘。`;
    newOne.album = Album.forge();
    return newOne;
  }

  static getFormModel(): FormGroupModel {
    const controls: { [key: string]: FormControlModel } = {
      name: {
        name: 'name',
        type: FormControlType.text,
        label: '名稱',
        validators: [
          {
            type: 'required',
            errorMessage: '請填入名稱'
          }
        ]
      },
      introduction: {
        name: 'introduction',
        type: FormControlType.textarea,
        label: '簡介',
        validators: [
          {
            type: 'required',
            errorMessage: '請填入簡介'
          }
        ]
      },
      album: {
        name: 'album',
        type: FormControlType.album,
        label: '相簿',
        default: new Album()
      }
    };

    const formModel = { name: 'play-form', controls };
    return formModel;
  }

  constructor() {
    this.id = uuid();
  }

  fromJSON(data: any): this {
    extend(this, data);
    if (data.album) {
      this.album = new Album().fromJSON(data.album);
    }
    return this;
  }

  toJSON(): any {
    const data = toJSONDeep(this);
    return data;
  }
}
