<div class="the-thing-editor" *ngIf="theThing">
  <form [formGroup]="formGroup">
    <ygg-action-bar-layout
      ><div ygg-action-bar-button [hidden]='!hasImitations'>
        <button
          type="button"
          mat-fab
          class="open-imitations"
          (click)="applyTemplate()"
          matTooltip="套用範本"
        >
          <mat-icon>library_books</mat-icon>
        </button>
      </div>
      <div ygg-action-bar-button>
        <button
          type="button"
          mat-fab
          class="submit"
          (click)="onSubmit()"
          [disabled]='formGroup.invalid || inProgressing'
          matTooltip="新增/修改"
        >
          <mat-icon>save</mat-icon>
        </button>
      </div>
      <div ygg-action-bar-content>
        <div
          *ngIf="pendingRelation"
          fxLayout="row"
          fxLayoutAlign="start center"
          fxLayoutGap="10px"
        >
          <h4>
            <mat-icon>call_merge</mat-icon>
            正在新增關聯<span style="color:blue">{{
              pendingRelation.data
            }}</span
            >的物件
          </h4>
          <button
            type="button"
            mat-mini-fab
            (click)="cancelPendingRelation()"
            matTooltip="取消關聯"
          >
            <mat-icon>cancel</mat-icon>
          </button>
        </div>
        <div class="meta">
          <br />
          <ygg-tags-control
            label="這東東是...（標籤）"
            taggableType="the-thing"
            class="tags"
            formControlName="tags"
          ></ygg-tags-control>
          <br />
          <mat-form-field class="name">
            <input
              matInput
              placeholder="這東東叫做...（名稱）"
              formControlName="name"
            />
          </mat-form-field>
        </div>
        <div class="add-cell">
          <ygg-title-divider>新增資料欄位</ygg-title-divider>
          <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">
            <div class="tags">
              <mat-form-field>
                <select
                  matNativeControl
                  placeholder="資料欄位型態"
                  [formControl]="formControlNewCellType"
                  required
                >
                  <option
                    *ngFor="let cellType of cellTypes | keyvalue"
                    [value]="cellType.key"
                  >
                    {{ cellType.value.label }}
                  </option>
                </select>
              </mat-form-field>
            </div>
            <div class="name">
              <mat-form-field>
                <input
                  matInput
                  placeholder="資料欄位名稱"
                  [formControl]="formControlNewCellName"
                  required
                />
              </mat-form-field>
            </div>
            <div>
              <button
                type="button"
                mat-mini-fab
                matTooltip="新增資料欄位"
                (click)="addCell()"
                [disabled]="
                  !(
                    formControlNewCellName.valid && formControlNewCellType.valid
                  )
                "
              >
                <mat-icon>add</mat-icon>
              </button>
            </div>
          </div>
        </div>
        <div class="cell-controls">
          <div *ngFor="let cellItem of theThing.cells | keyvalue">
            <div [attr.cell-name]="cellItem.key">
              <div fxLayout="row" fxLayoutAlign="end center" fxLayoutGap="10px">
                <button
                  class="delete"
                  mat-fab
                  (click)="deleteCell(cellItem.value)"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              <the-thing-cell-control
                [cell]="cellItem.value"
                [formGroup]="cellsFormGroup"
              ></the-thing-cell-control>
            </div>
          </div>
          <div fxLayout="row" fxLayoutAlign="end center" fxLayoutGap="10px">
            <button class="delete-all" mat-fab (click)="deleteAllCells()">
              <mat-icon>delete_sweep</mat-icon>
            </button>
          </div>
        </div>
        <div class="relations">
          <ygg-title-divider>關聯其他東東</ygg-title-divider>
          <div class="add-relation">
            <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">
              <div>
                <mat-form-field>
                  <input
                    type="text"
                    matInput
                    [formControl]="formControlNewRelationName"
                    class="relation-name"
                  />
                </mat-form-field>
                <!-- <mat-autocomplete>
        <mat-option *ngFor="let name of relationNames" [value]="name">
        {{ name }}
        </mat-option>
        </mat-autocomplete> -->
              </div>
              <div>
                <button
                  type="button"
                  mat-mini-fab
                  class="the-thing-create"
                  (click)="gotoCreateRelationObject()"
                  [disabled]="isNewRelationNameEmpty"
                >
                  <mat-icon>post_add</mat-icon>
                </button>
              </div>
              <div>
                <button
                  type="button"
                  mat-mini-fab
                  class="the-thing-finder"
                  (click)="openTheThingFinder()"
                  [disabled]="isNewRelationNameEmpty"
                >
                  <mat-icon>zoom_in</mat-icon>
                </button>
              </div>
            </div>
          </div>
          <div class="relation-list">
            <div
              *ngFor="let relation of relations | keyvalue"
              [attr.relation-name]="relation.key"
            >
              <h3>{{ relation.key }}</h3>
              <ygg-image-thumbnail-list
                [items$]='relation.value.objects$'
                (deleteItem)="onDeleteRelation(relation.key, $event)"
              ></ygg-image-thumbnail-list>
            </div>
          </div>
        </div></div
    ></ygg-action-bar-layout>
  </form>
</div>
