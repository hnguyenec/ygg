<div class="the-thing" *ngIf="theThing && imitation">
  <div
    fxLayout="row"
    fxLayoutAlign="space-between center"
    fxLayoutGap="30px"
    [formGroup]="formGroup"
  >
    <div>
      <div>
        <ygg-omni-type-view-control
          class="name"
          formControlName="name"
          type="text"
          [editable]="!readonly"
          [viewStyle]="nameStyle"
        >
          <div errors>
            <div *ngIf="formGroup.get('name').errors?.required">
              請填入{{ imitation.name }}名稱
            </div>
          </div>
        </ygg-omni-type-view-control>
      </div>
      <div class="state">
        <the-thing-state
          [id]="theThing.id"
          [imitation]="imitation"
        ></the-thing-state>
      </div>
      <div class="owner">
        <ygg-user-thumbnail [id]="theThing.ownerId"></ygg-user-thumbnail>
      </div>
    </div>
    <div fxLayout="row" fxLayoutAlign="end center" fxLayoutGap="20px">
      <div *ngFor="let action of actions">
        <div *ngIf="isThingValid()">
          <button
            type="button"
            mat-fab
            class="action"
            [ngClass]="action.id"
            [matTooltip]="action.tooltip"
            (click)="runAction(action)"
          >
            <mat-icon>{{ action.icon }}</mat-icon>
          </button>
        </div>
      </div>
      <div *ngIf="!readonly">
        <button
          type="button"
          mat-fab
          class="save edit"
          matTooltip="儲存體驗"
          [disabled]="!isThingValid()"
          (click)="save()"
        >
          <mat-icon>save</mat-icon>
        </button>
      </div>
    </div>
  </div>
  <div [formGroup]="formGroupCells" class="cells">
    <div *ngFor="let cellName of orderedCellNames">
      <div *ngIf="formGroupCells.get(cellName) as cellControl">
        <div
          [attr.cell-name]="cellName"
          [hidden]="!isCellControlShown(cellName)"
        >
          <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="20px">
            <ygg-title-divider [level]="4">{{ cellName }}</ygg-title-divider>
            <div *ngIf="!isCellRequired(cellName)">
              <button
                type="button"
                class="delete edit"
                mat-mini-fab
                [matTooltip]="'移除資料欄位 ' + cellName"
                (click)="deleteCell(cellName)"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          <the-thing-cell
            [formControlName]="cellName"
            [readonly]="readonly"
            [required]="isCellRequired(cellName)"
          ></the-thing-cell>
        </div>
      </div>
    </div>
  </div>
  <br /><br />
  <div
    fxLayout="row"
    fxLayoutAlign="start center"
    fxLayoutGap="10px"
    *ngIf="!readonly && isThingValid()"
  >
    <h4>
      增加其他資料
    </h4>
    <div>
      <button
        type="button"
        mat-mini-fab
        class="add-cell edit"
        (click)="addCell()"
      >
        <mat-icon>add</mat-icon>
      </button>
    </div>
  </div>
  <br /><br />
  <div *ngIf="isThingValid()">
    <div *ngFor="let relationshipMap of imitation.relationships | keyvalue">
      <div *ngIf="relationshipMap.value as relationship">
        <!-- <pre>{{ relationsMap[relationship.name] | json }}</pre> -->
        <div
          *ngIf="relationsMap[relationship.name] as relations"
          [attr.relation-name]="relationship.name"
        >
          <ygg-title-divider [level]="3" *ngIf="relations?.length > 0">{{
            relationship.name
          }}</ygg-title-divider>
          <div
            fxLayout="row wrap"
            fxLayoutAlign="space-around start"
            fxLayoutGap="30px"
          >
            <div *ngFor="let relation of relations" class="relation-object">
              <!-- <pre>{{ relation | json }}</pre> -->
              <the-thing-thumbnail
                [id]="relation.objectId"
                [imitation]="relationship.imitation"
              ></the-thing-thumbnail>
            </div>
          </div>
          <div
            fxLayout="row"
            fxLayoutAlign="start center"
            fxLayoutGap="10px"
            *ngIf="!readonly"
          >
            <h4>增加{{ relationship.name }}</h4>
            <div>
              <button
                type="button"
                mat-mini-fab
                class="create-relate-object edit"
                (click)="gotoRelateObjectCreate(relationship)"
              >
                <mat-icon>add</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
